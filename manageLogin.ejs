		var editor;
		var debug=false;
		 (function(d){
 		    var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
 		    if (d.getElementById(id)) {return;}
 		    js = d.createElement('script'); js.id = id; js.async = true;
 		    js.src = "//connect.facebook.net/en_US/all.js";
 		    ref.parentNode.insertBefore(js, ref);
 		  }(document));

 		window.fbAsyncInit = function() {
 		   FB.init({
		 	 appId      : '231629423618271', // App ID
 		     //channelUrl : 'http://concussionjs.COM/channel.html', // Channel File
 		     status     : true, // check login status
 		     cookie     : true, // enable cookies to allow the server to access the session
 		     xfbml      : true  // parse XFBML
 		   });
		
 		   // Additional initialization code here

 		 // Load the SDK Asynchronously
 		

 		    // listen for and handle auth.statusChange events
        FB.Event.subscribe('auth.statusChange', function(response) {
        	//alert(JSON.stringify(response));
          if (response.authResponse) {
            // user has auth'd your app and is logged into Facebook
            FB.api('/me', function(me){
         		
				if (me.name) {
					document.getElementById('auth-displayname').innerHTML = me.name;
				}
				//createCookie("sessionId",tenantId,1);
				createCookie("tenantId",me.id,1);
				createCookie("email",me.email,1);
				createCookie("updated_time",me.updated_time,1);
				getPage(readCookie("tenantId"),"index",submitFormData);
				mvm.users.getRecords();
				synchSessionVariables(readCookie("tenantId"));
            })
            document.getElementById('auth-loggedout').style.display = 'none';
            document.getElementById('auth-loggedin').style.display = 'block';
          } else {
            // user has not auth'd your app, or is not logged into Facebook
            document.getElementById('auth-loggedout').style.display = 'block';
            document.getElementById('auth-loggedin').style.display = 'none';
          }
        });

        // respond to clicks on the login and logout links
        $('#masthead-icon-facebook').click(function(){FB.login();});
        $('#facebook-signup').click(function(){FB.login();});
		$('#masthead-icon-logout').click(function(){
				FB.logout(); 
				//userId=""; 
				//createUUID(function(uuid)
				//{
					//createCookie("sessionId",uuid,1);
					createCookie("tenantId","",1);
					createCookie("email","",1);
					createCookie("updated_time","",1);
					synchSessionVariables(readCookie("sessionId"));
					editor.getSession().setValue("");
					submitFormData(readCookie("sessionId"));
				//});
		});
      } 

		
		$(document).ready(function(){

			aceEditorInit($(".editor"),"ace/theme/concussion");
			aceEditorInit($(".snippet"),"ace/theme/concussion-snippet");
			$(".justDoIt").click(justDoItForMe);
			$(".continue").click(justSubmit);
			$(".navigation").click(navigation);
			if(!readCookie("sessionId"))
			{
				//alert("inside no cookie");
				createUUID(function(uuid)
				{
					createCookie("sessionId",uuid,1);
					synchSessionVariables(readCookie("sessionId"));
				});
			}

			if(!readCookie("tenantId"))
			{	
				if(debug)
					console.log("No authenticated user or session");
				editor.getSession().setValue("");
				submitFormData(readCookie("sessionId"));
			}
			else
			{
				if(debug)
					console.log("tenantId:", readCookie("tenantId"));
				getPage(readCookie("tenantId"),"index",submitFormData);
			}

			$("#panel-header-icon-refresh").click(function(event){
					//alert("clicked");
					submitFormData();
			});	
		});

function justSubmit()
{
	var id = readCookie("tenantId");
	if(id=="")
		id=readCookie("sessionId");

	if(debug)
		console.log("justSubmit()");
	_gaq.push(['_trackEvent', 'TutorialAction', 'JustSubmit', id + "_" + (new Date())]);
	
	/*if(this.getAttribute("data-addContacts")=="true")
	{
		addThreeContactRecords();
	}*/
	submitFormData();
}

function justDoItForMe()
{
	var id = readCookie("tenantId");
	if(id=="")
		id=readCookie("sessionId");
	_gaq.push(['_trackEvent', 'TutorialAction', 'JustDoItForME', id + "_" + (new Date())]);
	editor.getSession().setValue(justDoIt[this.getAttribute("data-index")]);

	submitFormData();

}

function navigation()
{
	var id = readCookie("tenantId");
	if(id=="")
		id=readCookie("sessionId");
	_gaq.push(['_trackEvent', 'Navigation', this.getAttribute("data-section"), id + "_" + (new Date())]);
	
	console.log(this.getAttribute("data-section"));
}

function addThreeContactRecords()
{
	var id = readCookie("tenantId");
	if(id=="")
		id=readCookie("sessionId");
	addSampleRecords(3,"contacts",id);
}

function addSampleRecords(number,type,id)
{	
	for(i=0;i<number;i++)
	{
		var objectId="id_" + id + "_" + type;
		var nameVar = objectId + "_name";
		var emailVar = objectId + "_email";
		var phoneVar = objectId + "_phone";
		var nameVal = "name" + i;
		var emailVal = "email" + i;
		var phoneVal = "phone" + i;
		contact = "{\"" + nameVar + "\":\"" + nameVal + "\",\"" + emailVar + "\":\"" + emailVal + "\",\"" + phoneVar + "\":\"" + phoneVal + "\"}";

		$.ajax("http://<%=CJS_WEB_URL%>/createInstance/" + objectId, {
            data: contact,
            type: "POST",
            success: function(result) 
			{ 
				if(debug)				
					console.log("successfully added record " + i);	
			}
        });
	}
}

function aceEditorInit(editors,themePath)
{
	if(debug)
		console.log(editors.length);
	for(i=0;i<editors.length;i++)
	{
		if(debug)
			console.log(editors[i].id + " "+ editors[i].getAttribute("data-readonly"));
		eval(editors[i].id + "=ace.edit(\"" + editors[i].id + "\");");
		eval(editors[i].id + ".setTheme(\"" + themePath + "\");");
		eval(editors[i].id + ".getSession().setMode(\"ace/mode/html\");");
		eval(editors[i].id + ".setShowPrintMargin(false);");
		eval(editors[i].id + ".setReadOnly(" + editors[i].getAttribute("data-readonly") + ");");
		eval(editors[i].id + ".renderer.setShowGutter(" + editors[i].getAttribute("data-gutter") + ");");

		//eval(editors[i].id + ".resize();");
	}
}

function getPage(id,filename,callback)
{
	synchSessionVariables(id);
	$.ajax({
		//url: "http://testdrive.shift.com/getMergedJSandHTML/"+sessionId,
         url: "http://<%=CJS_WEB_URL%>/getEntryWhere/pages?id="+id+"&name="+filename,
         type: "get", 
         dataType:"text",
         success: function(result) 
		{ 
			console.log("get page result " + result);
			var obj = JSON.parse(result)
			//alert(""+obj.html);
			editor.getSession().setValue(obj.html);
			editor.resize();
			if(callback)
				callback();
		}
   	});
}

function openPage(link, subDomain)
{
	if(subDomain)
		window.open('http://<%=CJS_WEB_URL%>'.replace("api",subDomain) + link);
	else
		window.open('http://<%=CJS_WEB_URL%>' + link);
}

	function synchSessionVariables(id)
	{
		$("#synchSessionVariables").attr({"src":"http://<%=CJS_WEB_URL%>/setSessionVariables.html?sid="+ id});
	}

	function submitFormData(id)
	{
		//alert($("#codeArea").attr("value"));
		//alert(editor.getSession().getValue());
		if(!(id) || id=="")
			id=readCookie("tenantId");
		if(!(id) || id=="")
			id=readCookie("sessionId");
		var page={};
		page.html = editor.getSession().getValue();
		page.name="index"
		page.id=id;
		//alert(JSON.stringify(page));
		$.ajax({
			//url: "http://testdrive.shift.com/getMergedJSandHTML/"+sessionId,
        	url: "http://<%=CJS_WEB_URL%>/updateWhere/pages?id="+id,
        	data: JSON.stringify(page),//$("#codeArea").value,
    		type: "post", 
    		success: function(result) 
			{	 
				//alert(result);
				if(debug)
					console.log("http://<%=CJS_WEB_URL%>/admin.html?id="+ id);
				$("#preview").attr({"src":"http://<%=CJS_WEB_URL%>/getPage/"+ id + "/index"});
				$("#admin-app").attr({"src":"http://<%=CJS_WEB_URL%>/admin.html?id="+ id});
				$("#admin-console-app").attr({"src":"http://<%=CJS_WEB_URL%>/admin.html?id="+ id});
				synchSessionVariables(id);
			}
		});
	}

	function openUpPreviewWindow()
	{
		window.open("http://<%=CJS_WEB_URL%>/getpage/"+ readCookie("tenantId") + "/index");
	}

	var mvm;

$(function() {

	function fields(data)
			{
				//alert(data.type);
				
				var self = this;
				self.name=ko.observable(data.name);					
				self.type=ko.observable(data.type);			
				self._id=ko.observable(data._id);
					
			}
	// handle children
	


			var cjs_users = function(data)
			{	
				//alert(data);
				var self = this;
						if(!data)
							return [];
						if(data.domain)
						{
							self.domain=ko.observable(data.domain);
						}
						else
						{
							self.domain=ko.observable('');
						}

						if(data.name)
						{
							self.name=ko.observable(data.name);
						}
						else
						{
							self.name=ko.observable('');
						}
					
						if(data.companyname)
						{
							self.companyname=ko.observable(data.companyname);
						}
						else
						{
							self.companyname=ko.observable('');
						}
					
						if(data.email)
						{
							self.email=ko.observable(data.email);
						}
						else
						{
							self.email=ko.observable('');
						}

						if(data.key)
						{
							self.key=ko.observable(data.key);
							self.webLink=ko.observable('http://<%=CJS_WEB_URL%>/customLink/' + self.key() + '.js');
						}
						else
						{
							self.key=ko.observable('');
						}
					
						this.remove = function() {
    					   	$.ajax("http://<%=CJS_WEB_URL%>/delete/cjs_users/"+this.id(), {
    					   		data: '',
								type: "get", 
								dataType: "text",
								success: function(result)
								{
									$.getJSON("http://<%=CJS_WEB_URL%>/getEntryWhere/cjs_users", function(allData) {
										var mapped = $.map([allData], function(item) { return new cjs_users(item) });
										mvm.users.read(mapped);
									});
								}
							});
						}

						this.update = function() {
       						$.ajax("http://<%=CJS_WEB_URL%>/update/cjs_users/xxx/" + this.id() , {
							data: ko.toJSON(this),
							type: "post", dataType: "text",
							success: function(result) 
							{ 
								$.getJSON("http://<%=CJS_WEB_URL%>/getEntryWhere/cjs_users/?key="+readCookie("tenantId"), function(allData) {
									var mapped = $.map([allData], function(item) { return new cjs_users(item) });
									mvm.users.read(mapped);
									alert("Save successful")
								});
        				   	}
       						});
       						mvm.users.updateDomain(this.domain());
    					}	
						
						self.id=ko.observable(data._id);
						self.row=ko.observable("");
						self.myForm = ko.observable("");
					
			}
			
		


	function myViewModel()
	{
		var self = this;
	
		//self.users=ko.observableArray([]);
		self.users_search_results=ko.observableArray([]);
		//self.users(self.id_544447760_users_search_results);
		self.users_search_term=ko.observable();							

		
	//setFormData
		
	users_reset_form = function(me)
		{
			//alert(me.first_name());
	
			self.users.domain("");
	
			self.users.name("");
	
			self.users.companyname("");
	
			self.users.email("");
	
		}

	
	//initial load
	

	

	// create code
	

	self.users = {};
	self.usersForm = ko.observable();

    var usersCreateJSON = function(){
	self.usersForm({
		domain:self.users.domain,
		
		name:self.users.name,
		
		companyname:self.users.companyname,
		email:self.users.email
    	});
	}
    
	self.users.getRecords = function(callback)
	{
		if(readCookie("tenantId")=="")
			return;
		$.ajax(
			{url:"http://<%=CJS_WEB_URL%>/getEntryWhere/cjs_users/?key="+readCookie("tenantId"),
			dataType:"json",
			data:'',
			success:function(data){
				//alert("success");
				var mapped = $.map([data], function(item) { return new cjs_users(item) });
				self.users.read(mapped);
				//alert(mapped.length);
				if(mapped.length==0)
				{
					//alert("mapped==0");
					self.key=readCookie("tenantId");
					if(callback)
						callback();
					else
						mvm.users.getRecords();				
				}
			}			
		});
	}

    self.users.read=ko.observableArray([]);

    self.users.domain=ko.observable("");
		self.users.name=ko.observable("");
		self.users.companyname=ko.observable("");
		self.users.email=ko.observable("");
		self.users.key=ko.observable("");
    
    self.users.updateDomain = function(domain)
    {
    	 $.ajax("http://<%=CJS_WEB_URL%>/domains/add/registered/" + domain, {
			success: function(result) 
			{
				//alert("success " + myId);
				//mvm.users.getRecords(mvm.users.getRecords);
				//users_reset_form();
				if(debug)
					console.log("domain " + domain + " was registered");
			}
        });
    }

    self.users.create = function() {
    	var patt = new RegExp("usersForm","g");
        usersCreateJSON();
        $.ajax("http://<%=CJS_WEB_URL%>/create/cjs_users/" + readCookie("tenantId"), {
			data: ko.toJSON(self).replace(patt,"cjs_users","g"),
			type: "post",
			dataType: "text",
			success: function(result) 
			{
				//alert("success " + myId);
				mvm.users.updateDomain();
				mvm.users.getRecords(mvm.users.getRecords);
				//users_reset_form();
			}
        });

       
    }
	
	}

	mvm = new myViewModel();
	ko.applyBindings(mvm);
	mvm.users.getRecords(mvm.users.create);
});